name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5

      - name: Build
        run: uv build

      - name: Publish to PyPI
        run: uv publish --trusted-publishing always

  bump-tap:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: dexhunter/homebrew-vibe
          token: ${{ secrets.HOMEBREW_COMMITTER_TOKEN }}

      - name: Update formula from PyPI
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          sleep 30
          python3 - "$VERSION" <<'PYEOF'
          import json, re, sys, urllib.request
          version = sys.argv[1]
          with urllib.request.urlopen(f"https://pypi.org/pypi/vibe-clock/{version}/json") as r:
              data = json.loads(r.read())
          for f in data["urls"]:
              if f["packagetype"] == "sdist":
                  new_url, new_sha = f["url"], f["digests"]["sha256"]
                  break
          formula = open("Formula/vibe-clock.rb").read()
          # Only replace the first (top-level) url and sha256, not resource blocks
          formula = re.sub(
              r'(^  url )".*"',
              rf'\1"{new_url}"',
              formula, count=1, flags=re.MULTILINE,
          )
          formula = re.sub(
              r'(^  sha256 )"[a-f0-9]+"',
              rf'\1"{new_sha}"',
              formula, count=1, flags=re.MULTILINE,
          )
          open("Formula/vibe-clock.rb", "w").write(formula)
          print(f"Updated formula to {version}: {new_url}")
          PYEOF

      - name: Commit and push
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/vibe-clock.rb
          git diff --cached --quiet && exit 0
          git commit -m "vibe-clock ${VERSION}"
          git push
